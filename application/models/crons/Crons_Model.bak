<?php




/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

/**
 * Description of OrderExpiry_Model
 *
 * to cancel expired order
 * @author Ujwal Jain
 */
class Crons_Model extends CI_Model
{
    public function expired_order()
    {
        $db = $this->db;
        $fetch_data = "SELECT group_concat(cd.order_code,'#',cd.ordered_to_entity_id,'#',cd.order_by_userid,'#',cd.id) as data,count(cd.order_code) as count
        FROM cart_details cd
        WHERE now()>DATE_ADD(cd.order_time, INTERVAL 48 HOUR) AND cd.is_order_placed=1 AND cd.is_order_delivered=0 AND cd.is_order_cancel=0";

        $response = $db->query($fetch_data);
        $result = $response->result_array();

        $data = $result[0]['data'];
        $data_array = explode(',', $data);

        for ($i = 0; $i < count($data_array); $i++) {
            $query = "CALL SP_CANCEL_EXPIRED_ORDER('" . $data_array[$i] . "')";
            // echo $query;die;
            $sp_response = $db->query($query);
            $sp_response->next_result();
            $sp_response->free_result();
            // echo $query;die();
        }
        // echo '<pre>';
        // print_r($sp_response->result());
        // die();
        $db->close();
        return $sp_response;
    }

    public function UpdateActualBalance()
    {
        $db = $this->db;
        $query = "CALL SP_DAILY_UPDATE_STOCK()";
        $response = $db->query($query);
        $db->close();
        return $response;
    }


    public function cron_log($file_path)
    {
        $db = $this->db;
        $query = "INSERT INTO cron_log(file_name)values('$file_path')";
        $response = $db->query($query);
        $db->close();
    }
}
