<?php




/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

/**
 * Description of Order_model
 *
 * to display order details
 * @author Jitendra Pal
 */
class Order_model extends CI_Model
{


    // public function completeDeliveryProcess($order_code, $cart_id)
    // {
    //     $db = $this->db;
    //     $query = "CALL SP_DELIVER_LIQUOR(?,?)";
    //     $response = $db->query($query, array($order_code, $cart_id));
    //     $result = $response->result();
    //     $db->close();
    //     return $result;
    // }

    public function completeDeliveryProcess($order_code)
    {
        $db = $this->db;
        $query = "CALL SP_DELIVER_LIQUOR(?)";
        // echo $query;
        $response = $db->query($query, array($order_code));
        $result = $response->result();
        $db->close();
        return $result;
    }

    public function fetchDeliveryOrders($entity_id)
    {
        $db = $this->db;
        $query = "Select cd.order_code,cd.id as cart_id
                 from cart_details cd where ordered_to_entity_id=? and is_order_placed=1 and is_order_delivered=0";
        $response = $db->query($query, array($entity_id));
        $result['order_code_data'] = $response->result();
        return $result;
    }

    // to fetch cartDetails
    public function fetchOrderCartDetails($cart_order_code)
    {
        $db = $this->db;
        $query = "SELECT cd.id as cart_id,Concat(ld.brand,' ',ld.liquor_description,' ',ld.bottle_size) AS liquor_name,cd.order_code AS order_code,
                    ld.liquor_description_id AS liquor_id,
                    cd.cart_type,ld.liquor_type,ld.liquor_ml,ld.liquor_image,od.liquor_entity_id,cd.liquor_count,
                    concat(od.recevied_quantity,'_',lem.id,'_',cd.id) AS quantity, 
                    od.recevied_cost_lot_size as unit_lot_cost,cd.ordered_to_entity_id, 
                    (od.recevied_cost_lot_size * od.recevied_quantity) AS total_quantity_cost,
                    ca.username AS irla,CONCAT(ca.firstname,' ',ca.lastname) AS name,
                    Concat(me.entity_name,' - ',st.state) as entity_details,mt.entity_type,
                    od.is_liquor_removed AS is_liquor_removed FROM 
                    cart_details cd  
                    INNER JOIN  order_details AS od  ON cd.id=od.cart_id 
                    INNER JOIN liquor_entity_mapping lem ON lem.id=od.liquor_entity_id 
                    INNER JOIN liquor_details ld ON ld.liquor_description_id=lem.liquor_description_id
                    INNER JOIN ci_admin ca ON ca.admin_id =od.order_by
                    LEFT JOIN master_entities me ON  me.id=cd.order_from_entity_id
                    LEFT JOIN master_entity_type mt ON mt.id=cd.order_from_entity_type
                    LEFT JOIN master_state st ON st.id=me.state
                    WHERE cd.order_code=? AND od.is_liquor_removed=0 AND cd.is_order_placed=1 AND cd.is_order_delivered=0";
        $response = $db->query($query, array($cart_order_code));
        $result = $response->result_array();
        return $result;
    }


    public function fetchPrintReceipt($cart_order_code)
    {
        $db = $this->db;
        $query = "SELECT me.entity_name,me.address as canteen_address,ca.username as irla,			
                    Concat(ld.liquor_type,' ',ld.brand,' ',ld.liquor_description,' ',ld.bottle_size) as liquor_bill_description,
                    cd.order_code as order_code,
                    concat(od.recevied_quantity) as quantity, 
                    od.recevied_cost_lot_size as unit_lot_cost, 
                    (od.recevied_cost_lot_size * od.recevied_quantity) as total_quantity_cost FROM 
                    cart_details cd  
                    INNER JOIN order_details as od  ON cd.id=od.cart_id
                    INNER JOIN ci_admin as ca on ca.admin_id=od.order_by  
                    INNER JOIN liquor_entity_mapping lem ON lem.id=od.liquor_entity_id 
                    INNER JOIN master_entities me on me.id=lem.entity_id
                    INNER JOIN liquor_details ld ON ld.liquor_description_id=lem.liquor_description_id 
                    WHERE cd.order_code=? and od.is_liquor_removed=0 and cd.is_order_placed=1 and cd.is_order_delivered=1";
        $response = $db->query($query, array($cart_order_code));
        $result = $response->result_array();
        return $result;
    }

    public function deliveryCheckOut($cart_details)
    {
        $db = $this->db;
        $query = "CALL SP_DELIVERY_CART_CHECK_OUT('$cart_details')";

        $response = $db->query($query, array($cart_details));
        $result = $response->result();
        $db->close();
        return $result;
    }




























    public function placeOrder($cart_details)
    {
        $db = $this->db;
        $query = "CALL SP_CART_PLACE_ORDER('$cart_details')";
        // return $query;
        $response = $db->query($query);
        $result = $response->result();
        $db->close();
        return $result;
    }

    //FOR CART QUANTITY INCREMENT DECREMENT AND REMOVE FUNCITONALITY
    public function checkOut($cart_details)
    {
        $db = $this->db;
        $query = "CALL SP_CART_CHECK_OUT('$cart_details')";
        // return $query;
        $response = $db->query($query);
        $result = $response->result();
        $db->close();
        return $result;
    }

    // public function 
}
