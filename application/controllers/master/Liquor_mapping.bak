<?php


class Liquor_mapping extends MY_Controller
{

    //put your code here
    public function __construct()
    {
        parent::__construct();
        // auth_check(); // check login auth
        // $this->rbac->check_module_access();

        $this->load->model('Master/LiquorMapping_Model', 'liquor_mapping_master_model');
        $this->load->model('admin/Activity_model', 'activity_model');
        $this->load->helper(array('bsf_form/list_field', 'bsf_form/master_table', 'Ats/common'));
    }

    public function index()
    {
        $data = $this->liquor_mapping_master_model->fetchInitialAlcoholFormDetails();
        $this->load->view('admin/includes/_header');
        $this->load->view('liquor/liquorMappingView', $data);
        $this->load->view('admin/includes/_footer');
        // $liquor_data = $this->liquor_mapping_master_model->fetchAllLiquorMapRecords();

        // $liquor_data_array = json_decode(json_encode($liquor_data), true);

        // if (count($liquor_data_array) > 0) {
        //     $data['title'] = trans('liquor_list'); // header of the page

        //     $data['add_url'] = 'master/Liquor_mapping/addLiquorMappingDetails'; //url for adding new product on form submission

        //     $data['add_title'] = trans('liquor_add'); //add button titl on list page

        //     $data['table_head'] = LIQUOR_MAPPING_LIST; //from application/helpers/bsf_form list_field_helper //use to create table 

        //     $data['table_data'] = $liquor_data;

        //     $data['edit_url'] = 'master/Liquor_mapping/editLiquorMappingDetails';

        //     $data['csrf_url'] = 'master/Liquor_mapping';

        //     $this->load->view('admin/includes/_header');
        //     $this->load->view('master/masterTableView', $data);
        //     $this->load->view('admin/includes/_footer');
        // } else {

        //     $data = $this->liquor_mapping_master_model->fetchInitialAlcoholFormDetails();
        //     $this->load->view('admin/includes/_header');
        //     $this->load->view('liquor/liquorMappingView', $data);
        //     $this->load->view('admin/includes/_footer');
        // }
    }

    public function getLiquorBrandList()
    {
        // $this->rbac->check_operation_access(); // check opration permission
        $liquor_brand_id = $this->input->post('liquor_brand_id');
        $result = $this->liquor_mapping_master_model->fetchLiquorBrand($liquor_brand_id);
        echo json_encode($result);
    }

    public function getEntityList()
    {
        // $this->rbac->check_operation_access(); // check opration permission
        $entity_name_id = $this->input->post('entity_name_id');
        $result = $this->liquor_mapping_master_model->fetchEntityList($entity_name_id);
        echo json_encode($result);
    }

    public function addLiquorMappingDetails()
    {
        // $this->rbac->check_operation_access(); // check opration permission
        if ($this->input->post('submit')) {

            $data = array(
                'liquor_type' => $this->input->post('liquor_type'),
                'liquor_brand' => $this->input->post('liquor_brand'),
                'entity_type' => $this->input->post('entity_type'),
                'entity' => $this->input->post('entity'),
                'select_ml' => $this->input->post('select_ml'),
                'moq' => $this->input->post('moq'),
                'sell_price' => $this->input->post('sell_price'),
                'purchase_price' => $this->input->post('purchase_price'),
                'user_id' => $this->session->userdata('admin_id'),
                'available_quantity' => $this->input->post('available_quantity'),
                'mode' => 'A',
            );
            // echo '<pre>';
            // print_r($data);die();
            $response = $this->CheckEntityMasterForm();
            if ($response['success']) {
                $response['model_response'] = $this->insert_update_liquor_mapping_details($data);
            }
            echo json_encode($response);

            // $response = $this->insert_update_liquor_mapping_details($data);
        } else {

            $data = $this->liquormapping_model->fetchInitialAlcoholFormDetails();

            $this->load->view('admin/includes/_header');
            $this->load->view('liquor/liquorMappingView', $data);
            $this->load->view('admin/includes/_footer');
        }
    }

    public function editLiquorMappingDetails($id)
    {
        // $this->rbac->check_operation_access(); // check opration permission
        if ($this->input->post('submit')) {
            $data = array(
                'liquor_type' => $this->input->post('liquor_type'),
                'liquor_brand' => $this->input->post('liquor_brand'),
                'entity_type' => $this->input->post('entity_type'),
                'entity' => $this->input->post('entity'),
                'select_ml' => $this->input->post('select_ml'),
                'moq' => $this->input->post('moq'),
                'sell_price' => $this->input->post('sell_price'),
                'purchase_price' => $this->input->post('purchase_price'),
                'user_id' => $this->session->userdata('admin_id'),
                'id' => $id,
                'mode' => 'E',
            );

            $response = $this->CheckEntityMasterForm();
            if ($response['success']) {
                $response['model_response'] = $this->insert_update_liquor_mapping_details($data);
            }
            echo json_encode($response);
        } else {

            $data = $this->liquormapping_model->fetchAlcoholDetails($id);
            $this->load->view('admin/includes/_header');
            $this->load->view('liquor/liquorMappingView', $data);
            $this->load->view('admin/includes/_footer');
        }
    }

    public function insert_update_liquor_mapping_details($data)
    {
        $response = $this->liquor_mapping_master_model->insert_update_liquor_mapping_details(json_encode($data));

        if ($response[0]->V_SWAL_TYPE == 'success') {
            $this->session->set_userdata('action_messages', $response[0]->V_SWAL_TITLE);
            $this->session->set_userdata('action_messages', $response[0]->V_SWAL_MESSAGE);
            $this->session->set_userdata('swal_icon', $response[0]->V_SWAL_TYPE);
        }
        return $response;
    }

    public function CheckEntityMasterForm()
    {
        $this->form_validation->set_rules('liquor_type', 'Liquor type', 'trim|required');
        $this->form_validation->set_rules('liquor_brand', 'Liquor brand', 'trim|required');
        $this->form_validation->set_rules('entity_type', 'Entity type', 'trim|required');
        $this->form_validation->set_rules('entity', 'Entity', 'trim|required');
        // $this->form_validation->set_rules('select_ml[]', 'Select ml', 'trim|required|xss_clean|callback_multiple_selectstate');
        $this->form_validation->set_rules('moq', 'MOQ', 'trim|required');
        $this->form_validation->set_rules('sell_price', 'Sell Price', 'trim|required');
        $this->form_validation->set_rules('purchase_price', 'Purchase Price', 'trim|required');

        $this->form_validation->set_error_delimiters('<p class="text-danger" style="font-size:14px">', '</p>');
        if ($this->form_validation->run()) {
            $data['success'] = true;
        } else {
            $data['success'] = false;
            foreach ($_POST as $key => $value) {
                $data['messages'][$key] = form_error($key);
            }
        }
        return $data;
    }

    // //mapping liquor with city and entity  with 
    // public function viewProductEnityMapping() {
    //     $liquor_data = $this->liquor_mapping_master_model->fetchAllLiquorMapRecords();

    //     $liquor_data_array = json_decode(json_encode($liquor_data), true);

    //     if (count($liquor_data_array) > 0) {
    //         $data['title'] = trans('liquor_details'); // header of the page

    //         $data['add_url'] = 'master/Liquor_mapping/addLiquorEntityMapping'; //url for adding new product on form submission

    //         $data['add_title'] = trans('liquor_add'); //add button titl on list page

    //         $data['table_head'] = LIQUOR_MAPPING_LIST; //from application/helpers/bsf_form list_field_helper //use to create table 

    //         $data['table_data'] = $liquor_data;

    //         $data['edit_url'] = 'master/Liquor_mapping/editLiquorEntityMapping';

    //         $data['csrf_url'] = 'master/Liquor_mapping';

    //         $this->load->view('admin/includes/_header');
    //         $this->load->view('master/masterTableView', $data);
    //         $this->load->view('admin/includes/_footer');
    //     } else {

    //         $data = $this->liquor_mapping_master_model->fetchInitialAlcoholFormDetails();
    //         $this->load->view('admin/includes/_header');
    //         $this->load->view('liquor/liquorMappingView', $data);
    //         $this->load->view('admin/includes/_footer');
    //     }
    // }

}
